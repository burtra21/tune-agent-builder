# PDF Lead Magnet Hosting Guide

## Overview

The PDF lead magnet system generates personalized cost savings analysis PDFs for each casino prospect and serves them via the FastAPI server at `http://localhost:8000/pdf/{filename}`.

## Current Setup

### PDF Generation
- PDFs are generated by `worldclass_email_generator.py` during the email creation workflow
- Generated PDFs are saved to `pdf_lead_magnets/generated/`
- Each PDF is named: `{casino_name}_cost_analysis_{date}.pdf`

### PDF Serving
- The FastAPI server (`api_server.py`) serves PDFs via the `/pdf/{filename}` endpoint
- No authentication required for PDF access (they're meant to be shared publicly)
- PDFs are delivered with proper `application/pdf` content type

## Local Development

### 1. Start the API Server

```bash
cd "/Users/ryanburt/Orion - Tune /Tune Agent Builder"
uvicorn api_server:app --reload --port 8000
```

The server will be available at `http://localhost:8000`

### 2. Generate Emails with PDFs

```bash
python3 worldclass_email_generator.py
```

This will:
- Generate email sequences for all personas
- Create personalized PDF lead magnets
- Output PDF URLs like: `http://localhost:8000/pdf/{filename}`

### 3. Access PDFs

PDFs can be accessed at:
```
http://localhost:8000/pdf/{filename}
```

Example:
```
http://localhost:8000/pdf/bellagio_las_vegas_cost_analysis_20251030.pdf
```

### 4. List All PDFs (API)

```bash
curl -s "http://localhost:8000/api/pdf/list" \
  -H "X-API-Key: tune_dev_key_12345" | python3 -m json.tool
```

Response:
```json
{
  "count": 1,
  "pdfs": [
    {
      "filename": "bellagio_las_vegas_cost_analysis_20251030.pdf",
      "size_bytes": 161725,
      "created_at": "2025-10-30T14:01:22.978218",
      "url": "/pdf/bellagio_las_vegas_cost_analysis_20251030.pdf"
    }
  ]
}
```

## Railway Deployment

### Option 1: Deploy API Server to Railway

Railway is a simple cloud platform that can host the FastAPI server and serve PDFs publicly.

#### Step 1: Prepare for Deployment

1. **Create `railway.toml`** (already removed, but here's what it should contain):

```toml
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "uvicorn api_server:app --host 0.0.0.0 --port $PORT"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
```

2. **Add to `.gitignore`**:
```
.env
pdf_lead_magnets/generated/*.pdf
```

#### Step 2: Deploy to Railway

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login to Railway
railway login

# Initialize project
railway init

# Deploy
railway up
```

#### Step 3: Set Environment Variables in Railway

In Railway dashboard, set:
```
CLAUDE_API_KEY=your_api_key_here
PDF_BASE_URL=https://your-railway-app.railway.app
```

#### Step 4: Update `worldclass_email_generator.py`

The code already supports environment-based URLs:
```python
PDF_BASE_URL = os.getenv("PDF_BASE_URL", "http://localhost:8000")
```

For local development, no .env needed (defaults to localhost).
For production, set `PDF_BASE_URL` to Railway URL.

### Option 2: Deploy to Render

Similar to Railway, Render is another simple hosting option.

1. Connect GitHub repo to Render
2. Set build command: `pip install -r requirements.txt`
3. Set start command: `uvicorn api_server:app --host 0.0.0.0 --port $PORT`
4. Set environment variables (same as Railway)

## AWS S3 Alternative (Production-Grade)

For a more scalable, production-ready solution:

### Advantages
- No server required for PDFs
- Infinite scalability
- Very low cost (~$0.023 per GB/month)
- CDN integration via CloudFront

### Implementation

1. **Install boto3**:
```bash
pip install boto3
```

2. **Add S3 upload to PDF generator**:

```python
import boto3
from botocore.config import Config

def upload_pdf_to_s3(pdf_filename, bucket_name="tune-casino-pdfs"):
    """Upload PDF to S3 and return presigned URL"""
    s3_client = boto3.client('s3', config=Config(signature_version='s3v4'))

    # Upload file
    with open(f"pdf_lead_magnets/generated/{pdf_filename}", 'rb') as f:
        s3_client.upload_file(
            f"pdf_lead_magnets/generated/{pdf_filename}",
            bucket_name,
            pdf_filename,
            ExtraArgs={'ContentType': 'application/pdf'}
        )

    # Generate presigned URL (valid for 7 days)
    url = s3_client.generate_presigned_url(
        'get_object',
        Params={'Bucket': bucket_name, 'Key': pdf_filename},
        ExpiresIn=604800  # 7 days
    )

    return url
```

3. **Update environment variables**:
```bash
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_S3_BUCKET=tune-casino-pdfs
AWS_REGION=us-east-1
```

## Security Considerations

### Current Setup (No Auth on PDFs)
- PDFs are publicly accessible without authentication
- This is intentional - they're lead magnets meant to be shared
- Security through obscurity (long, random filenames)

### If You Need Authentication
Add API key requirement to the `/pdf/{filename}` endpoint:

```python
@app.get("/pdf/{filename}", tags=["PDF Lead Magnets"])
async def serve_pdf(filename: str, api_key: APIKey = Depends(require_auth)):
    """Serve PDF lead magnet files (PROTECTED)"""
    # ... rest of the code
```

## File Management

### Cleanup Old PDFs

Create a cleanup script to remove PDFs older than 30 days:

```python
import os
from pathlib import Path
from datetime import datetime, timedelta

def cleanup_old_pdfs(days=30):
    """Remove PDFs older than specified days"""
    pdf_dir = Path("pdf_lead_magnets/generated")
    cutoff_date = datetime.now() - timedelta(days=days)

    for pdf_file in pdf_dir.glob("*.pdf"):
        created_time = datetime.fromtimestamp(pdf_file.stat().st_ctime)
        if created_time < cutoff_date:
            pdf_file.unlink()
            print(f"Deleted old PDF: {pdf_file.name}")
```

### Monitor Disk Usage

```bash
du -sh pdf_lead_magnets/generated/
```

## Testing the Complete Flow

### Test End-to-End

1. **Start API server**:
```bash
uvicorn api_server:app --reload --port 8000
```

2. **Generate emails** (in another terminal):
```bash
python3 worldclass_email_generator.py
```

3. **Check the output** - you should see:
```
✓ PDF generated: bellagio_las_vegas_cost_analysis_20251030.pdf
✓ PDF URL: http://localhost:8000/pdf/bellagio_las_vegas_cost_analysis_20251030.pdf
```

4. **Test PDF access** in browser or with curl:
```bash
curl -o test.pdf "http://localhost:8000/pdf/bellagio_las_vegas_cost_analysis_20251030.pdf"
open test.pdf  # On Mac
```

## Troubleshooting

### PDF Not Found (404)
- Check that PDF exists: `ls pdf_lead_magnets/generated/`
- Verify filename matches exactly (case-sensitive)
- Check API server is running on port 8000

### Import Errors on API Server
- Ensure all modules are in `src/` folder
- Check imports use `from src.module_name` syntax
- Verify virtual environment is activated

### Railway/Render Deployment Issues
- Ensure `requirements.txt` includes all dependencies
- Check environment variables are set correctly
- Verify port is set to `$PORT` (Railway/Render provide this)
- Check logs: `railway logs` or Render dashboard

### PDF Generation Errors
- Verify `reportlab` and `matplotlib` are installed
- Check PDF directory exists and is writable
- Ensure prospect data contains all required fields

## Environment Variables Reference

### Local Development (.env)
```bash
CLAUDE_API_KEY=your_api_key_here
# PDF_BASE_URL defaults to http://localhost:8000
```

### Railway/Render Deployment
```bash
CLAUDE_API_KEY=your_api_key_here
PDF_BASE_URL=https://your-app-name.railway.app  # or .onrender.com
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

### AWS S3 Deployment
```bash
CLAUDE_API_KEY=your_api_key_here
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_S3_BUCKET=tune-casino-pdfs
AWS_REGION=us-east-1
PDF_BASE_URL=https://your-cloudfront-url.cloudfront.net
```

## API Endpoints Reference

### Public Endpoints (No Auth)
- `GET /pdf/{filename}` - Serve PDF file
- `GET /api/health` - Health check

### Protected Endpoints (Requires API Key)
- `GET /api/pdf/list` - List all generated PDFs
- All other API endpoints require `X-API-Key` header

## Next Steps

1. **For Development**: Current local setup works perfectly
2. **For Production**: Deploy to Railway or Render for simple hosting
3. **For Scale**: Migrate to AWS S3 + CloudFront for production-grade hosting

## Cost Estimates

### Railway (Hobby Plan)
- $5/month for starter plan
- 500 hours/month runtime
- Suitable for small-medium campaigns

### AWS S3
- Storage: ~$0.023/GB/month
- Requests: $0.0004 per 1000 GET requests
- Very cheap for typical usage (<$1/month for 1000 PDFs)

### Render (Free Tier)
- Free for personal projects
- Spins down after inactivity
- Good for testing, not production
